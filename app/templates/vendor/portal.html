<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Registration | Heritage Foods</title>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .text-heritage { color: #009C49; }
        .bg-heritage { background-color: #009C49; }
        .border-heritage { border-color: #009C49; }
        .hover-bg-heritage:hover { background-color: #007a3a; }
        .accent-heritage { accent-color: #009C49; }
        
        .std-input { height: 44px; width: 100%; border: 1px solid #d1d5db; border-radius: 0.375rem; padding-left: 0.75rem; padding-right: 0.75rem; font-size: 0.875rem; transition: all 0.2s; display: flex; align-items: center; background-color: white; }
        .std-input:focus { outline: none; border-color: #009C49; box-shadow: 0 0 0 3px rgba(0, 156, 73, 0.1); }
        .std-input:invalid:not(:placeholder-shown) { border-color: #ef4444; background-color: #fef2f2; }
        
        input[type="file"].std-input { padding: 0.25rem; }
        input[type="file"]::file-selector-button { height: 100%; margin-right: 1rem; background-color: #f3f4f6; border: none; border-right: 1px solid #e5e7eb; border-radius: 0.25rem; color: #374151; padding-left: 0.75rem; padding-right: 0.75rem; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        input[type="file"]::file-selector-button:hover { background-color: #e5e7eb; }
        textarea.std-input { height: auto; padding-top: 0.5rem; }
        
        .step-panel { display: none; }
        .step-panel.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .verify-btn { position: absolute; right: 5px; top: 5px; bottom: 5px; padding: 0 16px; font-size: 0.75rem; font-weight: 700; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.05em; transition: all 0.2s; display: flex; align-items: center; justify-content: center; z-index: 10; background-color: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
        .verify-btn:hover:not(:disabled) { background-color: #dbeafe; border-color: #93c5fd; }
        .verify-btn:disabled { background-color: #f3f4f6; color: #9ca3af; border-color: #e5e7eb; cursor: not-allowed; }
        .verify-btn.verified { background-color: #f0fdf4; color: #15803d; border-color: #bbf7d0; cursor: default; pointer-events: none; }

        .result-box { margin-top: 0.75rem; padding: 1rem; border-radius: 0.5rem; display: none; border: 1px solid transparent; animation: fadeIn 0.3s ease-out; width: 100%; grid-column: 1 / -1; }
        .result-box.success { background-color: #f0fdf4; border-color: #86efac; color: #14532d; }
        .result-box.error { background-color: #fef2f2; border-color: #fecaca; color: #b91c1c; }
        
        .result-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; font-size: 0.85rem; }
        @media (max-width: 640px) { .result-grid { grid-template-columns: 1fr; } }
        .result-label { font-weight: 600; color: #15803d; opacity: 0.8; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 2px; }
    </style>
    
    <script>
    // Global State for verification flags
    window.verificationState = {
        pan: {{ req.is_pan_verified | tojson }},
        gst: {{ req.is_gst_verified | tojson }},
        msme: {{ req.is_msme_verified | tojson }},
        bank: {{ req.is_bank_verified | tojson }}
    };

    function markUnverified(type) {
        // Prevent running before Alpine initializes
        if (!window._pageHydrated) return;
        
        // Prevent running if the user is just clicking the Submit button
        if (document.activeElement?.type === 'submit') return;

        // If it's already false, don't waste an API call
        if (window.verificationState[type] !== true) return;

        console.log('[UNVERIFY]', type);
        window.verificationState[type] = false;

        const btn = document.getElementById(`btn-verify-${type}`);
        if (btn) {
            btn.classList.remove('verified');
            btn.innerHTML = 'VERIFY';
            btn.disabled = false;
        }

        fetch('/vendor/api/unverify', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({
                vendor_request_id: '{{ req.request_id }}',
                section: type
            })
        });
    }

    async function verifySingle(type) {
        const btn = document.getElementById(`btn-verify-${type}`);
        const resultDiv = document.getElementById(`result-${type}`);
        const originalContent = btn.innerHTML;

        let formData = new FormData();
        formData.append('vendor_request_id', '{{ req.request_id }}');
        
        try {
            // --- 1. GATHER DATA ---
            if (type === 'gst') {
                formData.append('gst_number', document.querySelector('[name="gst_no"]').value.trim());
                const fileInput = document.querySelector('[name="gst_file"]');
                if (fileInput && fileInput.files.length > 0) formData.append('gst_file', fileInput.files[0]);
            } 
            else if (type === 'pan') {
                formData.append('pan_number', document.querySelector('[name="pan_no"]').value.trim());
                const fileInput = document.querySelector('[name="pan_file"]');
                if (fileInput && fileInput.files.length > 0) {
                    formData.append('pan_file', fileInput.files[0]);
                } else {
                    formData.append('pan_file_path', "{{ req.pan_file_path }}");
                }
                const aadhaarInput = document.querySelector('[name="aadhaar_no"]'); 
                if (aadhaarInput && aadhaarInput.offsetParent !== null) {
                    formData.append('aadhaar_number', aadhaarInput.value.trim());
                }
            } 
            else if (type === 'msme') {
                formData.append('msme_number', document.querySelector('[name="msme_number"]').value.trim());
                const fileInput = document.querySelector('[name="msme_file"]');
                if (fileInput && fileInput.files.length > 0) formData.append('msme_file', fileInput.files[0]);
            } 
            else if (type === 'bank') {
                formData.append('bank_account_no', document.querySelector('[name="acc_no"]').value.trim());
                formData.append('ifsc_code', document.querySelector('[name="ifsc"]').value.trim());
                const fileInput = document.querySelector('[name="bank_file"]');
                if (fileInput && fileInput.files.length > 0) formData.append('bank_file', fileInput.files[0]);
            }

            // --- 2. SHOW SPINNER ---
            btn.disabled = true;
            btn.innerHTML = `<svg class="animate-spin h-4 w-4 text-current" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            resultDiv.style.display = 'none';

            // --- 3. API CALL ---
            const response = await fetch('/vendor/api/verify-details', {
                method: 'POST',
                headers: { 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content') },
                body: formData
            });

            const data = await response.json();
            let html = '';
            let isSuccess = false;

            // --- 4. HANDLE RESPONSE ---
            if (data.error || !data.details) {
                html = `<strong>‚ö†Ô∏è System Error:</strong> ${data.error || 'Unknown Error'}`;
                isSuccess = false;
            } 
            else {
                // ... (Parsing logic remains the same, omitted for brevity but required in file) ...
                if (type === 'gst' && data.details.gst) {
                    const g = data.details.gst;
                    isSuccess = (g.gstin_status === 'Active' || g.status === 'Active');
                    html = isSuccess ? `<div class="flex items-center gap-2 mb-2 pb-2 border-b border-green-200"><span class="text-xl">‚úÖ</span> <span class="font-bold text-green-800 text-sm">GST Verified</span></div><div class="result-grid"><div><span class="result-label">Legal Name</span>${g.legal_name || 'N/A'}</div><div><span class="result-label">Status</span>${g.gstin_status}</div></div>` : `<strong>‚ùå Failed:</strong> ${g.status}`;
                }
                else if (type === 'pan' && data.details.pan) {
                    const p = data.details.pan;
                    isSuccess = p.is_valid;
                    html = isSuccess ? `<div class="flex items-center gap-2 mb-2 pb-2 border-b border-green-200"><span class="text-xl">‚úÖ</span> <span class="font-bold text-green-800 text-sm">PAN Validated</span></div><div class="result-grid"><div><span class="result-label">Name on Card</span>${p.ocr_name || 'N/A'}</div><div><span class="result-label">Aadhaar</span>${p.aadhaar_linked ? 'Linked' : 'Not Linked'}</div></div>` : `<strong>‚ùå Failed:</strong> ${p.status_text}`;
                }
                else if (type === 'msme' && data.details.msme) {
                    const m = data.details.msme;
                    isSuccess = (m.status === 'id_found' || m.status === 'Verified');
                    html = isSuccess ? `<div class="flex items-center gap-2 mb-2 pb-2 border-b border-green-200"><span class="text-xl">‚úÖ</span> <span class="font-bold text-green-800 text-sm">Udyam Verified</span></div><div class="result-grid"><div><span class="result-label">Enterprise</span>${m.name}</div></div>` : `<strong>‚ùå Failed:</strong> Check Number`;
                }
                else if (type === 'bank' && data.details.bank) {
                    const b = data.details.bank;
                    isSuccess = (String(b.account_exists).toUpperCase() === 'YES' || b.status === 'id_found' || String(b.account_exists) === 'true' || b.account_exists === true);
                    html = isSuccess ? `<div class="flex items-center gap-2 mb-2 pb-2 border-b border-green-200"><span class="text-xl">‚úÖ</span> <span class="font-bold text-green-800 text-sm">Bank Verified</span></div><div class="result-grid"><div><span class="result-label">Name at Bank</span>${b.name_at_bank || 'N/A'}</div></div>` : `<strong>‚ùå Failed:</strong> Unable to verify account.`;
                }
            }

            resultDiv.innerHTML = html;
            resultDiv.className = `result-box ${isSuccess ? 'success' : 'error'}`;
            resultDiv.style.display = 'block';

            if (isSuccess) {
                btn.classList.add('verified');
                btn.innerHTML = `‚úì VERIFIED`;
                window.verificationState[type] = true;
                
                // üî• THE FIX: Use Alpine.$data() for Version 3
                const appElement = document.querySelector('[x-data]');
                if(appElement && window.Alpine) {
                    const appData = Alpine.$data(appElement); // <--- THIS WAS THE FIX
                    
                    if(type === 'pan') appData.dbValues.pan = formData.get('pan_number').toUpperCase();
                    if(type === 'gst') appData.dbValues.gst = formData.get('gst_number').toUpperCase();
                    if(type === 'msme') appData.dbValues.msme = formData.get('msme_number').toUpperCase();
                    if(type === 'bank') {
                        appData.dbValues.bank_acc = formData.get('bank_account_no');
                        appData.dbValues.bank_ifsc = formData.get('ifsc_code').toUpperCase();
                    }
                }

            } else {
                btn.innerHTML = originalContent;
                window.verificationState[type] = false;
            }

        } catch (e) {
            console.error(e);
            resultDiv.innerHTML = `<strong>Error:</strong> ${e.message}`;
            resultDiv.className = 'result-box error';
            resultDiv.style.display = 'block';
            btn.innerHTML = originalContent;
        } finally {
            if(!window.verificationState[type]) btn.disabled = false; 
        }
    }
    </script>
</head>
<body class="bg-gray-50 min-h-screen pb-20">

    <header class="bg-white shadow-sm border-t-4 border-heritage sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4 h-20 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Heritage Foods" class="h-12 w-auto">
                <div class="hidden md:block h-8 w-px bg-gray-200"></div>
                <div>
                    <h1 class="text-lg font-bold text-gray-900 tracking-tight">Vendor Portal</h1>
                    <p class="text-xs text-gray-500 font-medium">Onboarding Application</p>
                </div>
            </div>
            <div class="bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-200">
                <p class="text-[10px] uppercase text-gray-500 font-bold tracking-wider">Ref ID</p>
                <p class="text-sm font-mono font-bold text-heritage">{{ req.request_id }}</p>
            </div>
        </div>
    </header>

    {% if req.status == 'PENDING_VENDOR' and req.last_query %}
    <div class="max-w-4xl mx-auto px-4 mt-6">
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-r-lg shadow-sm flex items-start gap-4">
            <div class="text-3xl">‚ö†Ô∏è</div>
            <div>
                <h3 class="text-lg font-bold text-yellow-800">Action Required: Correction Needed</h3>
                <p class="text-sm text-yellow-700 mt-1">Reviewer instruction: "{{ req.last_query }}"</p>
                <p class="text-xs text-yellow-600 mt-2 font-bold">Please make the necessary changes and re-submit.</p>
            </div>
        </div>
    </div>
    {% endif %}

    <main class="max-w-4xl mx-auto px-4 mt-8" x-data="{ 
        step: {{ initial_step|default(1) }}, 
        bankName: '{{ form.bank_name.data or req.bank_name or "" }}',
        accountHolder: '{{ form.holder_name.data or req.bank_account_holder_name or "" }}',
        
        gstReg: '{{ request.form.get("gst_reg") or req.gst_registered or "NO" }}', 
        msmeReg: '{{ request.form.get("msme_reg") or req.msme_registered or "NO" }}',
        constitution: '{{ request.form.get("constitution") or req.constitution or "" }}',

        panVal: '{{ form.pan_no.data or req.pan_number or "" }}',
        aadhaarVal: '{{ form.aadhaar_no.data or req.aadhaar_number or "" }}',

        gstConsent: {{ 'true' if request.form.get('gst_consent') or req.gst_registered == 'NO' else 'false' }},
        msmeConsent: {{ 'true' if request.form.get('msme_consent') or req.msme_registered == 'NO' else 'false' }},

        gstNo: '{{ form.gst_no.data or req.gst_number or "" }}',
        msmeNo: '{{ form.msme_number.data or req.msme_number or "" }}',
        ifscVal: '{{ form.ifsc.data or req.bank_ifsc or "" }}',
        accNo: '{{ form.acc_no.data or req.bank_account_no or "" }}',
        accNoConfirm: '{{ form.acc_no_confirm.data or req.bank_account_no or "" }}',
        
        submitting: false,

        // 1. Initial DB Values
        dbValues: {
            pan: '{{ (req.pan_number or "") | upper }}',
            gst: '{{ (req.gst_number or "") | upper }}',
            msme: '{{ (req.msme_number or "") | upper }}',
            bank_ifsc: '{{ (req.bank_ifsc or "") | upper }}',
            bank_acc: '{{ (req.bank_account_no or "") }}'
        },

        checkVerifyBtn(type) {
            const btn = document.getElementById('btn-verify-' + type);
            if(!btn) return;

            if (window.verificationState[type] === true) {
                btn.classList.add('verified');
                btn.innerHTML = '‚úì VERIFIED';
                btn.disabled = true; 
                return;
            }

            let valid = false;
            
            if(type === 'gst') {
                const num = document.getElementsByName('gst_no')[0].value;
                const file = document.getElementsByName('gst_file')[0].value;
                const savedFile = '{{ req.gst_file_path or "" }}';
                valid = (num.length === 15) && (file !== '' || savedFile !== '');
            }
            if(type === 'pan') {
                const num = this.panVal;
                const file = document.getElementsByName('pan_file')[0].value;
                const savedFile = '{{ req.pan_file_path or "" }}';
                let basicValid = (num.length === 10) && (file !== '' || savedFile !== '');
                
                if (num.length > 3 && num[3].toUpperCase() === 'P') {
                    const aadhaar = this.aadhaarVal;
                    valid = basicValid && (aadhaar.length === 12);
                } else {
                    valid = basicValid;
                }
            }
            if(type === 'msme') {
                const num = document.getElementsByName('msme_number')[0].value;
                const file = document.getElementsByName('msme_file')[0].value;
                const savedFile = '{{ req.msme_file_path or "" }}';
                valid = (num.length > 5) && (file !== '' || savedFile !== '');
            }
            if(type === 'bank') {
                const acc = document.getElementsByName('acc_no')[0].value;
                const ifsc = document.getElementsByName('ifsc')[0].value;
                const file = document.getElementsByName('bank_file')[0].value;
                const savedFile = '{{ req.bank_proof_file_path or "" }}';
                valid = (acc.length > 5) && (ifsc.length === 11) && (file !== '' || savedFile !== '');
            }

            btn.disabled = !valid; 
            btn.innerHTML = 'VERIFY'; 
            btn.classList.remove('verified');
        },

        validateAndNext(currentStep) {
            if (currentStep === 2) {
                if (this.gstReg === 'YES' && !window.verificationState.gst) {
                    alert('Action Required: Please click Verify inside the GST field.');
                    return;
                }
                if (!window.verificationState.pan) {
                    alert('Action Required: Please click Verify inside the PAN field.');
                    return;
                }
                if (this.msmeReg === 'YES' && !window.verificationState.msme) {
                    alert('Action Required: Please click Verify inside the Udyam field.');
                    return;
                }
            }
            
            if (currentStep === 3) {
                 if (!window.verificationState.bank) {
                    alert('Action Required: Please verify your Bank Account before submitting.');
                    return;
                }
            }

            const container = document.getElementById('step_' + currentStep);
            const inputs = container.querySelectorAll('input, select, textarea');
            let valid = true;
            for (const input of inputs) {
                if (!input.checkValidity()) {
                    input.reportValidity();
                    valid = false;
                    break; 
                }
            }
            if (valid) {
                this.step = currentStep + 1;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        },

        submitForm(e) {
            const form = document.querySelector('form');
            if (form.checkValidity()) {
                this.submitting = true;
            }
        }
    }"
    x-init="
        $nextTick(() => {
            window._pageHydrated = true; 
            ['pan', 'gst', 'msme', 'bank'].forEach(type => {
                checkVerifyBtn(type);
            });
        });

        // WATCHERS - Only unverify if value changes from what's in DB
        
        $watch('panVal', (val) => {
            if (val.toUpperCase() !== dbValues.pan) markUnverified('pan');
            checkVerifyBtn('pan');
        });

        $watch('aadhaarVal', () => {
            markUnverified('pan');
            checkVerifyBtn('pan');
        });

        $watch('gstNo', (val) => {
            if (val.toUpperCase() !== dbValues.gst) markUnverified('gst');
            checkVerifyBtn('gst');
        });

        $watch('msmeNo', (val) => {
            if (val.toUpperCase() !== dbValues.msme) markUnverified('msme');
            checkVerifyBtn('msme');
        });

        $watch('ifscVal', (val) => {
            if (val.toUpperCase() !== dbValues.bank_ifsc) markUnverified('bank');
            checkVerifyBtn('bank');
        });

        $watch('accNo', (val) => {
            // Safety: Don't unverify if it clears out (browser masking) unless real change
            if (val && val !== dbValues.bank_acc) markUnverified('bank');
            checkVerifyBtn('bank');
        });

        // ‚úÖ FIXED: Confirm field only updates button state, NEVER unverifies
        $watch('accNoConfirm', () => {
            checkVerifyBtn('bank');
        });
    ">
        <form method="POST" enctype="multipart/form-data" 
              @submit="submitForm"
              class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden relative" novalidate>
            {{ form.hidden_tag() }}
            
            <div id="step_1" class="step-panel p-8" :class="{ 'active': step === 1 }">
                <div class="mb-8 border-b border-gray-100 pb-4">
                    <h2 class="text-2xl font-bold text-gray-900">Organization Details</h2>
                    <p class="text-sm text-gray-500">Legal entity information.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-12 gap-6 mb-6">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Title <span class="text-red-500">*</span></label>
                        {{ form.title(class="std-input bg-gray-50 focus:bg-white") }}
                    </div>
                    <div class="md:col-span-5">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Legal Name <span class="text-red-500">*</span></label>
                        <input type="text" name="legal_name" 
                               class="std-input font-medium focus:ring-heritage" 
                               placeholder="As per PAN (Max 100 chars)" maxlength="100" 
                               value="{{ form.legal_name.data or req.vendor_name_basic or '' }}"
                               required>
                    </div>
                    <div class="md:col-span-5">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Trade Name</label>
                        {{ form.trade_name(class="std-input", placeholder="If different (Max 35 chars)", maxlength="35") }}
                    </div>
                    <div class="md:col-span-6">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Constitution <span class="text-red-500">*</span></label>
                        {{ form.constitution(class="std-input", **{'x-model': 'constitution'}) }}
                    </div>
                    <div class="md:col-span-6" x-show="constitution.toLowerCase().includes('company')" x-transition>
                        <label class="block text-xs font-bold text-blue-600 uppercase mb-1">CIN Number <span class="text-red-500">*</span></label>
                        <input type="text" name="cin_no" class="std-input bg-blue-50 border-blue-200 text-blue-800 font-mono uppercase" 
                               maxlength="21" placeholder="L12345MH2020PLC123456" 
                               :required="constitution.toLowerCase().includes('company')"
                               value="{{ form.cin_no.data or req.cin_number or '' }}">
                    </div>
                </div>

                <div class="bg-gray-50 rounded-xl p-6 border border-gray-200 mb-6">
                    <h3 class="text-sm font-bold text-gray-800 uppercase mb-4 flex items-center gap-2">Contact Person Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Name <span class="text-red-500">*</span></label>
                            {{ form.contact_name(class="std-input", maxlength="35") }}
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Designation <span class="text-red-500">*</span></label>
                            {{ form.designation(class="std-input", maxlength="35") }}
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Mobile No. <span class="text-red-500">*</span></label>
                            {{ form.mobile_1(class="std-input", type="tel", 
                                pattern="[0-9]{10}", maxlength="10", 
                                oninput="this.value = this.value.replace(/[^0-9]/g, '')",
                                placeholder="10 Digit Number") }}
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Alternate Mobile No.</label>
                            {{ form.mobile_2(class="std-input", type="tel", pattern="[0-9]{10}", maxlength="10", oninput="this.value = this.value.replace(/[^0-9]/g, '')", placeholder="Optional") }}
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Landline No.</label>
                            {{ form.landline(class="std-input", maxlength="31", placeholder="Optional") }}
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Products / Service Data <span class="text-red-500">*</span></label>
                            {{ form.product_desc(class="std-input", rows="2", maxlength="50", placeholder="Brief description (Max 50 chars)...") }}
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                     <h3 class="text-sm font-bold text-gray-800 uppercase mb-3">Registered Address <span class="text-red-500">*</span> </h3>
                     <div class="space-y-3">
                        {{ form.street_1(class="std-input", placeholder="Street 1 (Max 35 chars)", maxlength="35", required=True) }}
                        <div class="grid grid-cols-2 gap-3">
                            {{ form.street_2(class="std-input", placeholder="Street 2 (Max 40 chars)", maxlength="40") }}
                            {{ form.street_3(class="std-input", placeholder="Street 3 (Max 40 chars)", maxlength="40") }}
                            {{ form.street_4(class="std-input", placeholder="Street 4 (Max 40 chars)", maxlength="40") }}
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            {{ form.city(class="std-input", placeholder="City (Max 40 chars)", maxlength="40", required=True) }}
                            {{ form.pincode(class="std-input", placeholder="Pincode", type="text", pattern="[0-9]{6}", maxlength="10", required=True, oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 10);") }}
                            {{ form.state(class="std-input", required=True) }}
                        </div>
                     </div>
                </div>

                <div class="flex justify-end pt-4 border-t border-gray-100">
                    <button type="button" @click="validateAndNext(1)" class="bg-heritage text-white px-8 py-2.5 rounded-lg font-bold shadow hover:bg-green-700 transition h-11 flex items-center">Next &rarr;</button>
                </div>
            </div>

            <div id="step_2" class="step-panel p-8" :class="{ 'active': step === 2 }">
                <div class="mb-8 border-b border-gray-100 pb-4">
                    <h2 class="text-2xl font-bold text-gray-900">Tax & Compliance</h2>
                    <p class="text-sm text-gray-500">Statutory document uploads.</p>
                </div>

                <div class="mb-6 border rounded-xl p-5" :class="gstReg === 'YES' ? 'bg-white border-gray-200' : 'bg-gray-50 border-gray-200'">
                    <div class="flex justify-between items-center mb-4">
                        <label class="text-sm font-bold text-gray-800">GST Registered? <span class="text-red-500">*</span></label>
                        <div class="flex gap-4">
                            {% for subfield in form.gst_reg %}
                            <label class="flex items-center gap-2 cursor-pointer">
                                {{ subfield(class="accent-heritage w-5 h-5",
                                  **{'x-model': 'gstReg', 'onchange': "markUnverified('gst')"}) }}
                                <span class="text-sm font-medium">{{ subfield.label.text }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div x-show="gstReg === 'YES'" class="grid grid-cols-1 md:grid-cols-2 gap-5 border-t border-gray-100 pt-4">
                        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">GST Number <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <input type="text" name="gst_no"
                                           x-model="gstNo"
                                           @input="checkVerifyBtn('gst')"
                                           class="std-input uppercase font-mono pr-24" 
                                           maxlength="15" pattern="^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$" 
                                           oninput="this.value = this.value.toUpperCase(); checkVerifyBtn('gst')"
                                           placeholder="15 Digit GSTIN" :required="gstReg === 'YES'"
                                           value="{{ form.gst_no.data or req.gst_number or '' }}">
                                    <button type="button" id="btn-verify-gst" onclick="verifySingle('gst')" class="verify-btn" disabled>VERIFY</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Upload Certificate <span class="text-red-500">*</span></label>
                                <input type="file" name="gst_file" class="std-input" accept=".pdf, .png, .jpg, .jpeg" 
                                       :required="gstReg === 'YES' && '{{ req.gst_file_path or '' }}'.length === 0"
                                       @change="checkVerifyBtn('gst'); markUnverified('gst')">
                                
                                {% if req.gst_file_path %}
                                <div class="flex items-center gap-2 mt-1 text-xs text-green-700 bg-green-50 p-2 rounded border border-green-200">
                                    <span>‚úì File Uploaded</span>
                                    <a href="{{ url_for('static', filename='uploads/' + req.gst_file_path) }}" target="_blank" class="underline font-bold">View</a>
                                </div>
                                {% endif %}
                            </div>
                            <div id="result-gst" class="md:col-span-2 result-box"></div>
                        </div>
                    </div>
                    <div x-show="gstReg === 'NO'" class="pt-4 border-t border-gray-200">
                         <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-md">
                            <h4 class="text-xs font-bold text-yellow-900 uppercase mb-2 border-b border-yellow-200 pb-1">Declaration by Unregistered Vendor under GST Act</h4>
                            <label class="flex items-start gap-3 cursor-pointer">
                                <input type="checkbox" name="gst_consent" x-model="gstConsent" class="accent-heritage mt-1 w-4 h-4 min-w-[1rem] rounded border-gray-300" :required="gstReg === 'NO'">
                                <div class="text-xs text-yellow-800 space-y-2 leading-relaxed">
                                    <p class="font-semibold">I/We do hereby solemnly declare that:</p>
                                    <ol class="list-decimal pl-4 space-y-1">
                                        <li>I/We are not registered under the Goods and Services Tax (GST) Act, 2017.</li>
                                        <li>My/Our aggregate turnover during the current financial year is below the threshold limit prescribed under Section 22 of the CGST Act, 2017 / or I/We are otherwise not liable to registration under the GST Act.</li>
                                        <li>I/We are supplying goods/services as an unregistered person, and hence GST is not applicable on the invoice/bill raised by me/us.</li>
                                        <li>I/We undertake to inform immediately if I/We become liable for GST registration at any time in the future.</li>
                                        <li>I/We confirm that the information furnished above is true and correct to the best of my/our knowledge and belief.</li>
                                    </ol>
                                </div>
                            </label>
                         </div>
                    </div>
                </div>

                <div class="mb-6 bg-white border border-gray-200 rounded-xl p-5 shadow-sm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">PAN Number <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <input type="text" name="pan_no" x-model="panVal" class="std-input uppercase font-mono pr-24" 
                                           maxlength="10" pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" 
                                           oninput="this.value = this.value.toUpperCase(); checkVerifyBtn('pan')"
                                           placeholder="10 Digit PAN" required 
                                           value="{{ form.pan_no.data or req.pan_number or '' }}">
                                    <button type="button" id="btn-verify-pan" onclick="verifySingle('pan')" class="verify-btn" disabled>VERIFY</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Upload PAN Card <span class="text-red-500">*</span></label>
                                <input type="file" name="pan_file" class="std-input" accept=".pdf, .png, .jpg, .jpeg" 
                                       :required="'{{ req.pan_file_path or '' }}'.length === 0"
                                       @change="checkVerifyBtn('pan'); markUnverified('pan')">
                                
                                {% if req.pan_file_path %}
                                <div class="flex items-center gap-2 mt-1 text-xs text-green-700 bg-green-50 p-2 rounded border border-green-200">
                                    <span>‚úì File Uploaded</span>
                                    <a href="{{ url_for('static', filename='uploads/' + req.pan_file_path) }}" target="_blank" class="underline font-bold">View</a>
                                </div>
                                {% endif %}
                            </div>

                            <div class="md:col-span-2" 
                                 x-show="panVal.length >= 4 && panVal[3].toUpperCase() === 'P'" 
                                 x-transition>
                                 <div class="bg-yellow-50 p-4 rounded border border-yellow-200">
                                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">
                                        Aadhaar Number <span class="text-red-500">*</span> 
                                        <span class="text-[10px] font-normal text-gray-500">(Required for Individual PAN Verification)</span>
                                    </label>
                                    <input type="text" name="aadhaar_no" x-model="aadhaarVal" class="std-input tracking-widest" 
                                           maxlength="12" placeholder="Enter 12 Digit Aadhaar Number"
                                           pattern="[0-9]{12}" 
                                           oninput="this.value = this.value.replace(/[^0-9]/g, ''); checkVerifyBtn('pan'); markUnverified('pan')"
                                           value="{{ form.aadhaar_no.data or req.aadhaar_number or '' }}">
                                 </div>
                            </div>

                            <div id="result-pan" class="md:col-span-2 result-box"></div>
                        </div>
                    </div>
                </div>

                <div class="mb-6 border rounded-xl p-5" :class="msmeReg === 'YES' ? 'bg-white border-gray-200' : 'bg-gray-50 border-gray-200'">
                    <div class="flex justify-between items-center mb-4">
                        <label class="text-sm font-bold text-gray-800">MSME Registered? <span class="text-red-500">*</span></label>
                        <div class="flex gap-4">
                            {% for subfield in form.msme_reg %}
                            <label class="flex items-center gap-2 cursor-pointer">
                                {{ subfield(class="accent-heritage w-5 h-5",
                                  **{'x-model': 'msmeReg', 'onchange': "markUnverified('msme')"}) }}
                                <span class="text-sm font-medium">{{ subfield.label.text }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div x-show="msmeReg === 'YES'" class="grid grid-cols-1 md:grid-cols-2 gap-5 border-t border-gray-100 pt-4">
                        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                 <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Udyam Number <span class="text-red-500">*</span></label>
                                 
                                 <div class="relative">
                                     <input type="text" name="msme_number"
                                            x-model="msmeNo"
                                            @input="checkVerifyBtn('msme')"
                                            class="std-input uppercase pr-24" 
                                            maxlength="40" 
                                            :required="msmeReg === 'YES'" 
                                            oninput="this.value = this.value.toUpperCase(); checkVerifyBtn('msme')"
                                            value="{{ form.msme_number.data or req.msme_number or '' }}">
                                     <button type="button" id="btn-verify-msme" onclick="verifySingle('msme')" class="verify-btn" disabled>VERIFY</button>
                                 </div>
                            </div>
                            <div>
                                 <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Type <span class="text-red-500">*</span></label>
                                 {{ form.msme_type(class="std-input",
                                   **{
                                     'x-bind:required': "msmeReg === 'YES'",
                                     'onchange': "markUnverified('msme')"
                                   }) }}
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Upload MSME Certificate <span class="text-red-500">*</span></label>
                                <input type="file" name="msme_file" class="std-input" accept=".pdf, .png, .jpg, .jpeg" 
                                       :required="msmeReg === 'YES' && '{{ req.msme_file_path or '' }}'.length === 0"
                                       @change="checkVerifyBtn('msme'); markUnverified('msme')">
                                
                                {% if req.msme_file_path %}
                                <div class="flex items-center gap-2 mt-1 text-xs text-green-700 bg-green-50 p-2 rounded border border-green-200">
                                    <span>‚úì File Uploaded</span>
                                    <a href="{{ url_for('static', filename='uploads/' + req.msme_file_path) }}" target="_blank" class="underline font-bold">View</a>
                                </div>
                                {% endif %}
                            </div>
                            <div id="result-msme" class="md:col-span-2 result-box"></div>
                        </div>
                    </div>
                    <div x-show="msmeReg === 'NO'" class="pt-4 border-t border-gray-200">
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-md">
                            <h4 class="text-xs font-bold text-yellow-900 uppercase mb-2 border-b border-yellow-200 pb-1">Declaration by Non-MSME Vendor</h4>
                            <label class="flex items-start gap-3 cursor-pointer">
                                <input type="checkbox" name="msme_consent" x-model="msmeConsent" class="accent-heritage mt-1 w-4 h-4 min-w-[1rem] rounded border-gray-300" :required="msmeReg === 'NO'">
                                <div class="text-xs text-yellow-800 space-y-2 leading-relaxed">
                                    <p>I/We hereby declare that our organization is <strong>not registered as a Micro, Small or Medium Enterprise (MSME)</strong> under the Micro, Small and Medium Enterprises Development Act, 2006.</p>
                                    <p class="font-bold mt-2">We further confirm that:</p>
                                    <ul class="list-disc pl-4 space-y-1">
                                        <li>We do not possess a valid Udyam Registration Number.</li>
                                        <li>We are not eligible for MSME benefits under any applicable government regulations.</li>
                                        <li>The information provided above is true and correct to the best of our knowledge and belief.</li>
                                    </ul>
                                    <p class="italic mt-2 text-yellow-900 bg-yellow-100 p-2 rounded">We understand that if the above declaration is found to be false or misleading at any stage, we indemnify Heritage Foods Limited fully for the loss/penalty if any levied by the authorities with respect MSME Act‚Äô2006 which is attributable to our false or misleading statement.</p>
                                </div>
                            </label>
                       </div>
                   </div>
                </div>

                <div class="mb-6 bg-gray-50 border border-gray-200 rounded-xl p-5">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">TDS Exemption (Optional)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                             <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Certificate No.</label>
                            {{ form.tds_cert_no(class="std-input") }}
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Upload Document <span class="text-[10px] font-normal text-gray-400 normal-case">(PDF, JPG, PNG)</span></label>
                            <input type="file" name="tds_file" class="std-input" accept=".pdf, .png, .jpg, .jpeg">
                            
                            {% if req.tds_file_path %}
                            <div class="flex items-center gap-2 mt-1 text-xs text-green-700 bg-green-50 p-2 rounded border border-green-200">
                                <span>‚úì File Uploaded</span>
                                <a href="{{ url_for('static', filename='uploads/' + req.tds_file_path) }}" target="_blank" class="underline font-bold">View</a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="flex justify-between pt-4 border-t border-gray-100">
                    <button type="button" @click="step = 1" class="text-gray-600 font-bold hover:text-gray-900 h-11 flex items-center">&larr; Back</button>
                    <button type="button" @click="validateAndNext(2)" class="bg-heritage text-white px-8 py-2.5 rounded-lg font-bold shadow hover:bg-green-700 transition h-11 flex items-center">Next &rarr;</button>
                </div>
            </div>

            <div id="step_3" class="step-panel p-8" :class="{ 'active': step === 3 }">
                <div class="mb-8 border-b border-gray-100 pb-4">
                    <h2 class="text-2xl font-bold text-gray-900">Bank Details & Consent</h2>
                    <p class="text-sm text-gray-500">Secure payment information and legal declarations.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Bank Name <span class="text-red-500">*</span></label>
                        {{ form.bank_name(
                            class="std-input",
                            maxlength="60",
                            **{'@input': "markUnverified('bank'); checkVerifyBtn('bank')"}
                        ) }}
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Account Holder Name <span class="text-red-500">*</span></label>
                        {{ form.holder_name(
                            class="std-input",
                            maxlength="60",
                            **{'@input': "markUnverified('bank'); checkVerifyBtn('bank')"}
                        ) }}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Account Number <span class="text-red-500">*</span></label>
                            {{ form.acc_no(
                                class="std-input mb-3",
                                placeholder="Enter Account No",
                                type="password",
                                maxlength="18",
                                **{'x-model': 'accNo'}
                            ) }}

                            {{ form.acc_no_confirm(
                                class="std-input",
                                placeholder="Confirm Account No",
                                maxlength="18",
                                **{'x-model': 'accNoConfirm'}
                            ) }}
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">IFSC Code <span class="text-red-500">*</span></label>
                            
                            <div class="relative">
                                <input type="text" name="ifsc"
                                       x-model="ifscVal"
                                       @input="checkVerifyBtn('bank')"
                                       class="std-input uppercase font-mono pr-24"
                                       maxlength="11" oninput="this.value = this.value.toUpperCase(); checkVerifyBtn('bank')"
                                       required
                                       value="{{ form.ifsc.data or req.bank_ifsc or '' }}">
                                <button type="button" id="btn-verify-bank" onclick="verifySingle('bank')" class="verify-btn" disabled>VERIFY</button>
                            </div>
                        </div>

                        <div class="md:col-span-2">
                             <div class="bg-blue-50 border border-blue-100 rounded-xl p-6 mb-2">
                                 <div class="flex items-start gap-4">
                                    <div class="p-2 bg-blue-100 text-blue-600 rounded-full"><span class="text-xl">üìé</span></div>
                                    <div class="w-full">
                                        <label class="block text-sm font-bold text-gray-800 mb-1">Upload Cancelled Cheque / Passbook <span class="text-red-500">*</span></label>
                                        
                                        <input type="file" name="bank_file" class="std-input" accept=".pdf, .png, .jpg, .jpeg" 
                                               :required="'{{ req.bank_proof_file_path or '' }}'.length === 0"
                                               @change="checkVerifyBtn('bank'); markUnverified('bank')">

                                        {% if req.bank_proof_file_path %}
                                        <div class="flex items-center gap-2 mt-2 text-xs text-green-700 bg-green-50 p-2 rounded border border-green-200">
                                            <span>‚úì File Uploaded</span>
                                            <a href="{{ url_for('static', filename='uploads/' + req.bank_proof_file_path) }}" target="_blank" class="underline font-bold">View</a>
                                        </div>
                                        {% endif %}
                                    </div>
                                 </div>
                            </div>
                        </div>
                        <div id="result-bank" class="md:col-span-2 result-box"></div>
                    </div>
                </div>

                <div class="bg-gray-50 border border-gray-200 rounded-xl p-5 mb-8">
                    <div class="flex items-start gap-4">
                        <div class="pt-0.5">
                            {{ form.agree_consent(class="accent-heritage w-5 h-5 cursor-pointer rounded border-gray-300", required=True) }}
                        </div>
                        <div>
                            <label for="agree_consent" class="block text-sm font-bold text-gray-900 cursor-pointer mb-1">
                                Data Privacy Consent (DPDP Act, 2023) <span class="text-red-500">*</span>
                            </label>
                            <p class="text-xs text-gray-600 leading-relaxed text-justify">
                                By proceeding, I hereby freely, specifically, and unequivocally consent to <strong>Heritage Foods Limited</strong> collecting, storing, using, and processing my personal data and, where applicable, the personal data of authorized representatives, for purposes including vendor onboarding, contract management, payments, statutory and regulatory compliance, audits, and related business operations.
                            </p>
                            <p class="text-xs text-gray-600 leading-relaxed text-justify mt-2">
                                I acknowledge that such processing shall be carried out in accordance with the <strong>Digital Personal Data Protection Act, 2023</strong>, and the <strong>Heritage Foods Limited Privacy Policy</strong>. I understand that I may exercise my rights as a Data Principal, including access, correction, erasure, and grievance redressal, in the manner provided therein, subject to applicable legal and contractual obligations.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between pt-4 border-t border-gray-100">
                    <button type="button" @click="step = 2" class="text-gray-600 font-bold hover:text-gray-900 h-11 flex items-center" :disabled="submitting">
                        &larr; Back
                    </button>

                    <button type="submit" 
                            class="bg-heritage text-white px-10 py-2.5 rounded-lg font-bold shadow-lg flex items-center gap-2 transition transform"
                            :class="{ 'opacity-50 cursor-not-allowed': submitting, 'hover:bg-green-700 hover:-translate-y-0.5': !submitting }"
                            :disabled="submitting">
                        
                        <svg x-show="submitting" class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>

                        <span x-text="submitting ? 'Processing...' : 'Submit Application'"></span>
                    </button>
                </div>
            </div>

        </form>
    </main>

    <footer class="mt-12 text-center text-gray-400 text-xs pb-8">
        <p>&copy; 2025 Heritage Foods Ltd. All rights reserved.</p>
    </footer>

</body>
</html>