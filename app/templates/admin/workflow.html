{% extends "base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<div class="min-h-screen bg-gray-50 flex flex-col">
    <div class="bg-white border-b border-gray-200 sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-8 h-16 items-center">
                <span class="text-xl font-bold text-gray-800 tracking-tight mr-4">Admin Portal</span>
                <a href="?active_tab=dashboard" class="inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors duration-200 {{ 'border-blue-500 text-gray-900' if activeTab == 'dashboard' else 'border-transparent text-gray-500 hover:text-gray-700' }}">Dashboard</a>
                <a href="?active_tab=users" class="inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors duration-200 {{ 'border-blue-500 text-gray-900' if activeTab == 'users' else 'border-transparent text-gray-500 hover:text-gray-700' }}">Users</a>
                <a href="?active_tab=masters" class="inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors duration-200 {{ 'border-blue-500 text-gray-900' if activeTab == 'masters' else 'border-transparent text-gray-500 hover:text-gray-700' }}">Master Data</a>
                <a href="?active_tab=logic" class="inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors duration-200 {{ 'border-blue-500 text-gray-900' if activeTab == 'logic' else 'border-transparent text-gray-500 hover:text-gray-700' }}">Workflow Logic</a>
            </div>
        </div>
    </div>

    <div class="flex-1 max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8">

        {% if activeTab == 'dashboard' %}
        <div class="space-y-8">
            <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
                <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between"><div><dt class="text-xs font-bold text-gray-400 uppercase">Total Requests</dt><dd class="text-3xl font-bold text-gray-900 mt-1">{{ stats.total }}</dd></div><div class="bg-gray-100 p-3 rounded-lg text-2xl">ğŸ“Š</div></div>
                <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between"><div><dt class="text-xs font-bold text-blue-400 uppercase">Pending Action</dt><dd class="text-3xl font-bold text-blue-600 mt-1">{{ stats.pending }}</dd></div><div class="bg-blue-50 p-3 rounded-lg text-2xl">â³</div></div>
                <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between"><div><dt class="text-xs font-bold text-green-400 uppercase">Completed</dt><dd class="text-3xl font-bold text-green-600 mt-1">{{ stats.completed }}</dd></div><div class="bg-green-50 p-3 rounded-lg text-2xl">âœ…</div></div>
                <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between"><div><dt class="text-xs font-bold text-red-400 uppercase">Rejected</dt><dd class="text-3xl font-bold text-red-600 mt-1">{{ stats.rejected }}</dd></div><div class="bg-red-50 p-3 rounded-lg text-2xl">ğŸš«</div></div>
            </div>
            
            <div>
                <h2 class="text-lg font-bold text-gray-900 mb-4">ğŸ“ Pipeline Bottlenecks</h2>
                <div class="grid grid-cols-5 gap-4">
                    <div class="bg-orange-50 border border-orange-100 rounded-lg p-4 text-center"><div class="text-xs font-bold text-orange-400 uppercase">Phase 1: Dept</div><div class="text-4xl font-bold text-orange-600">{{ stats.bottlenecks.dept }}</div><div class="text-[10px] text-orange-400 mt-1">Stuck at Internal</div></div>
                    <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 text-center"><div class="text-xs font-bold text-blue-400 uppercase">Fin: Bill Passing</div><div class="text-4xl font-bold text-blue-600">{{ stats.bottlenecks.bill }}</div><div class="text-[10px] text-blue-400 mt-1">Stuck at Basic Check</div></div>
                    <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 text-center"><div class="text-xs font-bold text-blue-400 uppercase">Fin: Treasury</div><div class="text-4xl font-bold text-blue-600">{{ stats.bottlenecks.treasury }}</div><div class="text-[10px] text-blue-400 mt-1">Stuck at Bank Check</div></div>
                    <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 text-center"><div class="text-xs font-bold text-blue-400 uppercase">Fin: Tax Team</div><div class="text-4xl font-bold text-blue-600">{{ stats.bottlenecks.tax }}</div><div class="text-[10px] text-blue-400 mt-1">Stuck at TDS/GST</div></div>
                    <div class="bg-purple-50 border border-purple-100 rounded-lg p-4 text-center"><div class="text-xs font-bold text-purple-400 uppercase">Phase 3: IT</div><div class="text-4xl font-bold text-purple-600">{{ stats.bottlenecks.it }}</div><div class="text-[10px] text-purple-400 mt-1">Stuck at SAP ID</div></div>
                </div>
            </div>

            <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100 bg-gray-50"><h3 class="text-sm font-bold text-gray-700 uppercase">Requests by Department</h3></div>
                <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Department</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total Requests</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Share</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">{% for dept in departments %}<tr class="hover:bg-gray-50"><td class="px-6 py-4 text-sm font-medium text-gray-900">{{ dept.name }}</td><td class="px-6 py-4 text-right text-sm text-gray-500 font-mono">{{ stats.req_by_dept.get(dept.name, 0) }}</td><td class="px-6 py-4 text-right text-sm">{% set count = stats.req_by_dept.get(dept.name, 0) %}{% set percent = (count / stats.total * 100)|round|int if stats.total > 0 else 0 %}<div class="w-24 ml-auto bg-gray-200 rounded-full h-1.5"><div class="bg-blue-600 h-1.5 rounded-full" style="width: {{ percent }}%"></div></div><span class="text-xs text-gray-400">{{ percent }}%</span></td></tr>{% endfor %}</tbody></table>
            </div>
        </div>
        {% endif %}

        {% if activeTab == 'users' %}
            {% if not user_dept_view %}
            <div class="space-y-6">
                <h1 class="text-2xl font-bold text-gray-900">User Management by Department</h1>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">{% for d in departments %}{% set stats = dept_user_stats.get(d.name, {'initiator':0, 'approver':0}) %}<a href="?active_tab=users&user_dept={{ d.name }}" class="block group bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md hover:border-blue-300 transition-all p-6"><div class="flex justify-between items-center mb-4"><div class="p-3 rounded-lg bg-blue-50 text-2xl group-hover:bg-blue-100">{% if d.name == 'IT' %}ğŸ’»{% elif d.name == 'Finance' %}ğŸ’°{% else %}ğŸ¢{% endif %}</div><span class="bg-gray-100 text-gray-600 py-1 px-3 rounded-full text-xs font-medium">{{ stats.initiator + stats.approver }} Users</span></div><h3 class="text-lg font-bold text-gray-900 group-hover:text-blue-600 mb-3">{{ d.name }}</h3><div class="flex gap-2 text-xs"><span class="bg-green-50 text-green-700 px-2 py-1 rounded border border-green-100">ğŸš€ {{ stats.initiator }} Initiators</span><span class="bg-purple-50 text-purple-700 px-2 py-1 rounded border border-purple-100">âœ… {{ stats.approver }} Approvers</span></div></a>{% endfor %}</div>
            </div>
            {% else %}
            <div class="space-y-6"><div class="flex items-center justify-between"><div class="flex items-center gap-4"><a href="?active_tab=users" class="p-2 rounded-full hover:bg-gray-200 text-gray-500">â† Back</a><h1 class="text-2xl font-bold text-gray-900">{{ user_dept_view }} Department Users</h1></div><button onclick="document.getElementById('addUserModal').classList.remove('hidden')" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 shadow-sm text-sm font-medium flex items-center gap-2"><span>+</span> Add User</button></div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col h-full"><div class="p-4 border-b border-gray-100 bg-green-50 rounded-t-lg flex justify-between items-center"><h2 class="font-bold text-green-800 flex items-center gap-2"><span class="text-xl">ğŸš€</span> Initiators</h2><span class="bg-white text-green-600 px-2 py-0.5 rounded text-xs font-bold shadow-sm">{{ dept_initiators|length }}</span></div><div class="p-4 space-y-3 flex-1">{% for u in dept_initiators %}<div class="flex items-center justify-between p-3 bg-white border border-gray-100 rounded-lg hover:shadow-sm hover:border-green-200 transition-all group"><div class="flex items-center gap-3"><div class="h-8 w-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center font-bold text-xs">{{ u.username[:2] }}</div><div><div class="text-sm font-bold text-gray-900">{{ u.username }}</div><div class="text-xs text-gray-500">{{ u.email }}</div>{% if u.assigned_category %}<div class="text-[10px] text-green-600 mt-0.5 font-medium">Category: {{ u.assigned_category }}</div>{% endif %}</div></div><form method="POST" onsubmit="return confirm('Remove {{ u.username }}?');"><input type="hidden" name="active_tab" value="users"><input type="hidden" name="user_dept_hidden" value="{{ user_dept_view }}"><input type="hidden" name="delete_user_id" value="{{ u.id }}"><button class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">ğŸ—‘ï¸</button></form></div>{% else %}<div class="text-center py-8 text-gray-400 text-sm italic">No initiators assigned.</div>{% endfor %}</div></div><div class="bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col h-full"><div class="p-4 border-b border-gray-100 bg-purple-50 rounded-t-lg flex justify-between items-center"><h2 class="font-bold text-purple-800 flex items-center gap-2"><span class="text-xl">âœ…</span> Approvers</h2><span class="bg-white text-purple-600 px-2 py-0.5 rounded text-xs font-bold shadow-sm">{{ dept_approvers|length }}</span></div><div class="p-4 space-y-3 flex-1">{% for u in dept_approvers %}<div class="flex items-center justify-between p-3 bg-white border border-gray-100 rounded-lg hover:shadow-sm hover:border-purple-200 transition-all group"><div class="flex items-center gap-3"><div class="h-8 w-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center font-bold text-xs">{{ u.username[:2] }}</div><div><div class="text-sm font-bold text-gray-900">{{ u.username }}</div><div class="text-xs text-gray-500">{{ u.email }}</div></div></div><form method="POST" onsubmit="return confirm('Remove {{ u.username }}?');"><input type="hidden" name="active_tab" value="users"><input type="hidden" name="user_dept_hidden" value="{{ user_dept_view }}"><input type="hidden" name="delete_user_id" value="{{ u.id }}"><button class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">ğŸ—‘ï¸</button></form></div>{% else %}<div class="text-center py-8 text-gray-400 text-sm italic">No approvers assigned.</div>{% endfor %}</div></div></div></div>
            <div id="addUserModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"><div class="bg-white rounded-xl p-6 w-96"><form method="POST"><input type="hidden" name="active_tab" value="users"><input type="hidden" name="user_dept_hidden" value="{{ user_dept_view }}"><input type="hidden" name="user_dept" value="{{ user_dept_view }}"><div class="grid grid-cols-2 gap-4"><input type="text" name="new_user_name" placeholder="Name" required class="border p-2 rounded"><input type="email" name="new_user_email" placeholder="Email" required class="border p-2 rounded"></div><div class="grid grid-cols-2 gap-4 mt-4"><select name="user_role" class="border p-2 rounded"><option value="initiator">Initiator</option><option value="approver">Approver</option></select><input type="text" name="assigned_category" placeholder="Category (Opt)" class="border p-2 rounded"></div><button class="mt-4 bg-blue-600 text-white px-4 py-2 rounded w-full">Create</button></form></div></div>
            {% endif %}
        {% endif %}

        {% if activeTab == 'masters' %}
            {% if not selected_master_cat %}
            <div class="space-y-6"><h1 class="text-2xl font-bold text-gray-900">Master Data</h1><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">{% for cat in master_categories %}<a href="?active_tab=masters&master_cat={{ cat }}" class="block group bg-white rounded-xl border border-gray-200 shadow-sm p-6 hover:shadow-md"><div class="flex justify-between mb-4"><div class="p-3 rounded-lg bg-blue-50 text-2xl group-hover:bg-blue-100">{% if 'BANK' in cat %}ğŸ¦{% elif 'REGION' in cat %}ğŸ—ºï¸{% elif 'PAYMENT' in cat %}ğŸ’³{% else %}ğŸ“‹{% endif %}</div></div><h3 class="text-lg font-bold text-gray-900 group-hover:text-blue-600">{{ cat.replace('_', ' ').title() }}</h3></a>{% endfor %}</div></div>
            {% else %}
            <div class="space-y-6"><div class="flex items-center justify-between"><div class="flex items-center gap-4"><a href="?active_tab=masters" class="p-2 rounded-full hover:bg-gray-200 text-gray-500">â† Back</a><h1 class="text-2xl font-bold text-gray-900">{{ selected_master_cat.replace('_', ' ').title() }}</h1></div><button onclick="document.getElementById('addMasterModal').classList.remove('hidden')" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 shadow-sm font-medium">+ Add Item</button></div><div class="bg-white shadow-sm rounded-lg border border-gray-200 overflow-hidden"><table class="min-w-full divide-y divide-gray-200"><tbody class="bg-white divide-y divide-gray-200">{% for item in master_items %}<tr><td class="px-6 py-4">{{ item.code }}</td><td class="px-6 py-4">{{ item.label }}</td><td class="px-6 py-4 text-right"><form method="POST" class="inline" onsubmit="return confirm('Delete?');"><input type="hidden" name="active_tab" value="masters"><input type="hidden" name="master_category" value="{{ selected_master_cat }}"><input type="hidden" name="delete_master_id" value="{{ item.id }}"><button class="text-red-600">ğŸ—‘ï¸</button></form></td></tr>{% endfor %}</tbody></table></div></div>
            <div id="addMasterModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"><div class="bg-white rounded-xl p-6 w-96"><form method="POST"><input type="hidden" name="active_tab" value="masters"><input type="hidden" name="master_category" value="{{ selected_master_cat }}"><input type="text" name="new_master_code" placeholder="Code" class="w-full border p-2 rounded mb-2"><input type="text" name="new_master_label" placeholder="Label" class="w-full border p-2 rounded mb-4"><button class="bg-blue-600 text-white px-4 py-2 rounded w-full">Save</button></form></div></div>
            {% endif %}
        {% endif %}

        {% if activeTab == 'logic' %}
            {% if not logic_view %}
            
            <div class="mb-10">
                <h1 class="text-2xl font-bold text-gray-900 mb-6">Workflow Pipeline Map</h1>
                <div class="flex items-center gap-4 overflow-x-auto pb-4">
                    <div class="flex-1 bg-white border border-orange-200 rounded-xl p-6 relative shadow-sm">
                        <span class="absolute top-0 right-0 bg-orange-100 text-orange-700 text-[10px] font-bold px-2 py-1 rounded-bl-lg">PHASE 1</span>
                        <div class="text-3xl mb-2">ğŸ¢</div>
                        <h3 class="font-bold text-gray-900">Department Internal</h3>
                        <p class="text-xs text-gray-500 mt-1">Configurable per Dept below &darr;</p>
                    </div>
                    <div class="text-gray-300 text-2xl">&rarr;</div>
                    <a href="?active_tab=logic&logic_view=FINANCE_COMMON" class="flex-1 bg-white border border-blue-200 rounded-xl p-6 relative shadow-sm ring-2 ring-blue-50 hover:bg-blue-50 transition-colors cursor-pointer group">
                        <span class="absolute top-0 right-0 bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-1 rounded-bl-lg">PHASE 2 (FIXED)</span>
                        <div class="text-3xl mb-2">âš–ï¸</div>
                        <h3 class="font-bold text-gray-900 group-hover:text-blue-700">Common Finance Chain</h3>
                        <p class="text-xs text-gray-500 mt-1">Bill Passing &rarr; Treasury &rarr; Tax.</p>
                        <div class="mt-2 text-xs font-bold text-blue-600 underline">Click to Edit Emails</div>
                    </a>
                    <div class="text-gray-300 text-2xl">&rarr;</div>
                    <a href="?active_tab=logic&logic_view=IT_COMMON" class="flex-1 bg-white border border-purple-200 rounded-xl p-6 relative shadow-sm hover:bg-purple-50 transition-colors cursor-pointer group">
                        <span class="absolute top-0 right-0 bg-purple-100 text-purple-700 text-[10px] font-bold px-2 py-1 rounded-bl-lg">PHASE 3</span>
                        <div class="text-3xl mb-2">ğŸ’»</div>
                        <h3 class="font-bold text-gray-900 group-hover:text-purple-700">Common IT Chain</h3>
                        <p class="text-xs text-gray-500 mt-1">Routing via Account Group.</p>
                        <div class="mt-2 text-xs font-bold text-purple-600 underline">Click to Edit Routes</div>
                    </a>
                </div>
            </div>

            <div class="space-y-6">
                <h2 class="text-lg font-bold text-orange-900 border-b pb-2">Phase 1: Department Internal Configuration</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% for d in departments %}
                        <a href="?active_tab=logic&logic_view={{ d.name }}" class="block group bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md hover:border-orange-300 transition-all p-6">
                            <div class="flex justify-between items-center mb-4"><div class="p-3 rounded-lg bg-orange-50 text-2xl group-hover:bg-orange-100">{% if d.name == 'IT' %}ğŸ’»{% elif d.name == 'Finance' %}ğŸ’°{% else %}ğŸ¢{% endif %}</div><span class="bg-gray-100 text-gray-600 py-1 px-3 rounded-full text-xs font-medium">{{ dept_rule_counts.get(d.name, 0) }} Rules</span></div>
                            <h3 class="text-lg font-bold text-gray-900 group-hover:text-orange-600">{{ d.name }} Internal</h3>
                            <p class="text-xs text-gray-400 mt-2">Manage internal budget approvals.</p>
                        </a>
                    {% endfor %}
                </div>
            </div>

            {% else %}
            
            {% if logic_view == 'FINANCE_COMMON' %}
            <div class="space-y-6">
                <div class="flex items-center gap-4"><a href="?active_tab=logic" class="p-2 rounded-full hover:bg-gray-200 text-gray-500">â† Back</a><h1 class="text-2xl font-bold text-blue-900">Common Finance Chain Configuration</h1></div>
                <div class="bg-white shadow-sm rounded-lg border border-blue-200 p-6">
                    <p class="text-sm text-gray-500 mb-4">The system follows this exact sequence. Update the email addresses for the users who perform these checks.</p>
                    <table class="min-w-full text-sm"><thead class="bg-blue-50 text-xs text-blue-700 uppercase"><tr><th class="px-6 py-3 text-left">Seq</th><th class="px-6 py-3 text-left">Role Name</th><th class="px-6 py-3 text-left">Assigned Email</th></tr></thead><tbody class="divide-y divide-blue-100">{% for u in finance_users %}<tr><td class="px-6 py-4 font-bold text-blue-800">{{ loop.index }}</td><td class="px-6 py-4 font-medium">{{ u.username }}</td><td class="px-6 py-4 text-gray-600 flex items-center gap-2">{{ u.email }} <button onclick="openLogicEditModal('finance_user', {{ u.id }}, '{{ u.email }}')" class="text-blue-400 hover:text-blue-600">âœï¸</button></td></tr>{% endfor %}</tbody></table>
                </div>
            </div>

            {% elif logic_view == 'IT_COMMON' %}
            <div class="space-y-6">
                <div class="flex items-center justify-between"><div class="flex items-center gap-4"><a href="?active_tab=logic" class="p-2 rounded-full hover:bg-gray-200 text-gray-500">â† Back</a><h1 class="text-2xl font-bold text-purple-900">Common IT Chain Configuration</h1></div><button onclick="document.getElementById('addITModal').classList.remove('hidden')" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 shadow-sm font-medium">+ Add Route</button></div>
                <div class="bg-white shadow-sm rounded-lg border border-purple-200 overflow-hidden">
                    <table class="min-w-full text-sm"><thead class="bg-purple-50 text-xs text-purple-700 uppercase"><tr><th class="px-6 py-3 text-left">Account Group</th><th class="px-6 py-3 text-left">Assigned IT Email</th><th class="px-6 py-3"></th></tr></thead>
                        <tbody class="divide-y divide-purple-100">
                            {% for it in dept_it_routes %}
                            <tr>
                                <td class="px-6 py-3 font-mono text-gray-900">{{ it.account_group }} 
                                    <span class="text-gray-400 ml-2 text-xs font-bold">{% if it.account_group in ['ZDOM', 'ZIMP', 'ZSER', 'ZFOP'] %}(MM){% else %}(FI){% endif %}</span>
                                </td>
                                <td class="px-6 py-3 text-gray-600 flex items-center gap-2">{{ it.it_assignee_email }} <button onclick="openLogicEditModal('it_route', {{ it.id }}, '{{ it.it_assignee_email }}')" class="text-blue-400 hover:text-blue-600">âœï¸</button></td>
                                <td class="px-6 py-3 text-right"><form method="POST" class="inline" onsubmit="return confirm('Delete?');"><input type="hidden" name="active_tab" value="logic"><input type="hidden" name="logic_view" value="IT_COMMON"><input type="hidden" name="delete_it_id" value="{{ it.id }}"><button class="text-gray-300 hover:text-red-500">ğŸ—‘ï¸</button></form></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div id="addITModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"><div class="bg-white rounded-xl p-6 w-96"><h3 class="font-bold mb-4">Add IT Route</h3><form method="POST"><input type="hidden" name="active_tab" value="logic"><input type="hidden" name="logic_view" value="IT_COMMON"><input type="text" name="new_account_group" placeholder="Group (e.g. ZDOM)" class="w-full border p-2 rounded mb-2"><input type="email" name="it_email" placeholder="IT Email" class="w-full border p-2 rounded mb-4"><div class="flex justify-end gap-2"><button type="button" onclick="document.getElementById('addITModal').classList.add('hidden')" class="text-gray-500">Cancel</button><button class="bg-purple-600 text-white px-4 py-2 rounded">Save</button></div></form></div></div>
            </div>

            {% else %}
            <div class="space-y-8">
                <div class="flex items-center gap-4"><a href="?active_tab=logic" class="p-2 rounded-full hover:bg-gray-200 text-gray-500">â† Back</a><h1 class="text-2xl font-bold text-gray-900">{{ logic_view }} Internal Rules</h1></div>
                <div class="bg-white shadow-sm rounded-lg border border-blue-200 p-6 border-l-4 border-l-blue-500"><div class="flex justify-between items-center mb-4 border-b pb-2"><div><h2 class="text-lg font-bold text-blue-900">ğŸ“‚ Category Routing</h2><p class="text-xs text-gray-500">Specific approval chains based on vendor category.</p></div><button onclick="document.getElementById('addCatModal').classList.remove('hidden')" class="text-blue-600 text-xs font-bold bg-blue-50 px-3 py-1 rounded hover:bg-blue-100">+ Add Rule</button></div>{% if dept_rules %}<table class="min-w-full text-sm"><thead class="bg-blue-50 text-xs text-blue-700 uppercase"><tr><th class="px-4 py-2 text-left">Category</th><th class="px-4 py-2 text-left">L1 Manager</th><th class="px-4 py-2 text-left">L2 Head</th><th></th></tr></thead><tbody class="divide-y divide-blue-100">{% for r in dept_rules %}<tr><td class="px-4 py-3 font-bold text-blue-700">{{ r.category_name }}</td><td class="px-4 py-3">{{ r.l1_manager_email }} <button onclick="openLogicEditModal('cat_l1', {{ r.id }}, '{{ r.l1_manager_email }}')" class="text-blue-400 hover:text-blue-600">âœï¸</button></td><td class="px-4 py-3">{{ r.l2_head_email }} <button onclick="openLogicEditModal('cat_l2', {{ r.id }}, '{{ r.l2_head_email }}')" class="text-blue-400 hover:text-blue-600">âœï¸</button></td><td class="px-4 py-3 text-right"><form method="POST" class="inline" onsubmit="return confirm('Delete?');"><input type="hidden" name="active_tab" value="logic"><input type="hidden" name="logic_view" value="{{ logic_view }}"><input type="hidden" name="delete_rule_id" value="{{ r.id }}"><button class="text-blue-300 hover:text-red-500">ğŸ—‘ï¸</button></form></td></tr>{% endfor %}</tbody></table>{% else %}<p class="text-sm text-gray-400 italic py-2">No category-specific rules defined.</p>{% endif %}</div>
                <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6"><div class="flex justify-between items-center mb-4 border-b pb-2"><div><h2 class="text-lg font-bold text-gray-900">âœ… Standard Steps</h2><p class="text-xs text-gray-500">Drag to reorder.</p></div><button onclick="document.getElementById('addStepModal').classList.remove('hidden')" class="text-green-600 text-xs font-bold bg-green-50 px-3 py-1 rounded hover:bg-green-100">+ Add Step</button></div>
                    <table class="min-w-full text-sm"><thead class="bg-gray-50 text-xs text-gray-500 uppercase"><tr><th class="px-4 py-2 w-10"></th><th class="px-4 py-2 text-left">Step</th><th class="px-4 py-2 text-left">Role</th><th class="px-4 py-2 text-left">Email</th><th></th></tr></thead><tbody id="stepsList" class="divide-y divide-gray-100">{% for s in dept_steps %}<tr class="bg-white hover:bg-gray-50" data-id="{{ s.id }}"><td class="px-4 py-3 cursor-move text-gray-400">â˜°</td><td class="px-4 py-3 font-bold step-number">{{ loop.index }}</td><td class="px-4 py-3">{{ s.role_label }}</td><td class="px-4 py-3 text-gray-600">{{ s.approver_email }} <button onclick="openLogicEditModal('step', {{ s.id }}, '{{ s.approver_email }}')" class="text-blue-400 hover:text-blue-600">âœï¸</button></td><td class="px-4 py-3 text-right"><form method="POST" class="inline" onsubmit="return confirm('Delete?');"><input type="hidden" name="active_tab" value="logic"><input type="hidden" name="logic_view" value="{{ logic_view }}"><input type="hidden" name="delete_step_id" value="{{ s.id }}"><button class="text-gray-300 hover:text-red-500">ğŸ—‘ï¸</button></form></td></tr>{% endfor %}</tbody></table></div>
                <div id="addCatModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"><div class="bg-white rounded-xl p-6 w-96"><form method="POST"><input type="hidden" name="active_tab" value="logic"><input type="hidden" name="logic_view" value="{{ logic_view }}"><input type="text" name="new_category_name" placeholder="Category" class="w-full border p-2 rounded mb-2"><input type="email" name="l1_email" placeholder="L1 Email" class="w-full border p-2 rounded mb-2"><input type="email" name="l2_email" placeholder="L2 Email" class="w-full border p-2 rounded mb-4"><button class="bg-blue-600 text-white px-4 py-2 rounded w-full">Save</button></form></div></div>
                <div id="addStepModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"><div class="bg-white rounded-xl p-6 w-96"><form method="POST"><input type="hidden" name="active_tab" value="logic"><input type="hidden" name="logic_view" value="{{ logic_view }}"><input type="text" name="new_step_role" placeholder="Role Label" class="w-full border p-2 rounded mb-2"><input type="email" name="new_step_email" placeholder="Email" class="w-full border p-2 rounded mb-4"><button class="bg-green-600 text-white px-4 py-2 rounded w-full">Save</button></form></div></div>
            </div>
            {% endif %}
            
            {% endif %}
        {% endif %}

    </div>
</div>

<div id="updateEmailModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"><div class="bg-white rounded-xl p-6 w-96"><h3 class="font-bold text-lg mb-4">Update Email</h3><form method="POST"><input type="hidden" name="active_tab" value="logic"><input type="hidden" name="logic_view" value="{{ logic_view if logic_view else '' }}"><input type="hidden" name="update_logic_type" id="updateType"><input type="hidden" name="rule_id" id="updateId"><input type="email" name="new_email" id="updateEmailInput" required class="w-full border border-gray-300 p-2 rounded mb-4"><div class="flex justify-end gap-2"><button type="button" onclick="document.getElementById('updateEmailModal').classList.add('hidden')" class="text-gray-500">Cancel</button><button class="bg-blue-600 text-white px-4 py-2 rounded">Update</button></div></form></div></div>

<script>
    function openLogicEditModal(type, id, currentEmail) {
        document.getElementById('updateType').value = type;
        document.getElementById('updateId').value = id;
        document.getElementById('updateEmailInput').value = currentEmail;
        document.getElementById('updateEmailModal').classList.remove('hidden');
    }
    const list = document.getElementById('stepsList');
    if (list) {
        new Sortable(list, {
            animation: 150, ghostClass: 'bg-blue-50', handle: '.cursor-move',
            onEnd: function (evt) {
                let order = []; list.querySelectorAll('tr').forEach(row => order.push(row.getAttribute('data-id')));
                list.querySelectorAll('.step-number').forEach((span, index) => { span.innerText = index + 1; });
                fetch('/admin/reorder_steps', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ step_ids: order }) });
            }
        });
    }
</script>
{% endblock %}